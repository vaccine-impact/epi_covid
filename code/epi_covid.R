# epi_covid.R
# run it from the source directory

# To assess the health benefits of vaccination versus the risks of sustaining or
# suspending immunisation programmes in Africa during the COVID-19 pandemic.

# load libraries
library (countrycode)
library (data.table)
library (ggplot2)
library (rnaturalearth)
library (rnaturalearthdata)
library (rriskDistributions)
library (scales)
library (tictoc)
library (tidyverse)
library (bayestestR)


# remove all objects from workspace
rm (list = ls ())


# ------------------------------------------------------------------------------
# functions
# ------------------------------------------------------------------------------

# ------------------------------------------------------------------------------
# Extract vaccine coverage estimates for 2018 from WHO for 54 African countries
# ------------------------------------------------------------------------------
get_vaccine_coverage <- function (age_group) {

  # Source: WHO vaccine-preventable diseases: monitoring system 2019 global summary
  # Last update: 10 Dec 2019
  # http://www.who.int/entity/immunization/monitoring_surveillance/data/coverage_series.xls

  load ("data/data.vaccine_coverage.rda")
  vaccine_coverage <- data.vaccine_coverage

  # year of vaccination
  setnames (vaccine_coverage,
            old = c ("Cname",   "Year"),
            new = c ("Country", "vac_year") )

  # extract data for 54 countries in Africa
  vaccine_coverage <- vaccine_coverage [Continent == "Africa" & vac_year == 2018 ]

  # ----------------------------------------------------------------------------
  # extract data for DTP3 vaccine
  vaccine_coverage_dtp <- vaccine_coverage [Vaccine %in% c("DTP3")]

  vaccine_coverage_diphtheria <- copy (vaccine_coverage_dtp)
  vaccine_coverage_tetanus    <- copy (vaccine_coverage_dtp)
  vaccine_coverage_pertussis  <- copy (vaccine_coverage_dtp)

  vaccine_coverage_diphtheria [, Vaccine := "Diphtheria (DTP3)"]
  vaccine_coverage_tetanus    [, Vaccine := "Tetanus (DTP3)"  ]
  vaccine_coverage_pertussis  [, Vaccine := "Pertussis (DTP3)"]

  # ----------------------------------------------------------------------------

  # extract data for 9 vaccines
  # HepB3, Hib3, HPVfem, MCV1, MenA, PCV3, RotaC, RCV1, YFV
  vaccine_coverage <- vaccine_coverage [Vaccine %in% c("HepB3", "Hib3", "HPVfem",
                                                       "MCV1", "MCV2", "MenA", "PCV3",
                                                       "RotaC", "RCV1", "YFV")]

  # add vaccine coverage data for DTP3 vaccine
  vaccine_coverage <- rbindlist (list (vaccine_coverage,
                                       vaccine_coverage_diphtheria,
                                       vaccine_coverage_tetanus,
                                       vaccine_coverage_pertussis),
                                 use.names = T)

  # drop HPVfem for under-5 children
  if (age_group == "under5") {

    vaccine_coverage <- vaccine_coverage [Vaccine != "HPVfem"]
  }

  # return vaccine coverage estimates
  return (vaccine_coverage)

} # end of function -- get_vaccine_coverage
# ------------------------------------------------------------------------------


# ------------------------------------------------------------------------------
# Add population estimates from UNWPP 2019
# ------------------------------------------------------------------------------
add_population <- function (vaccine_coverage) {

  vaccine_coverage_pop <- vaccine_coverage

  # add population year
  vaccine_coverage_pop [, pop_year := 2020]

  # add age of vaccination
  vaccine_coverage_pop [, age := 0]
  vaccine_coverage_pop [Vaccine == "MCV2",   age := 1]
  vaccine_coverage_pop [Vaccine == "HPVfem", age := 12]
  vaccine_coverage_pop [Vaccine == "HPVfem" & Country == "South Africa", age := 9]
  vaccine_coverage_pop [Vaccine == "HPVfem" & Country == "Ethiopia",     age := 14]

  # add gender
  vaccine_coverage_pop [, gender := "both"]
  vaccine_coverage_pop [Vaccine == "HPVfem", gender := "female"]

  # load unwpp 2019 population estimates
  load ("data/data.population_both.rda")
  load ("data/data.population_female.rda")

  # add population
  vaccine_coverage_pop_both <- merge (
    vaccine_coverage_pop [gender == "both"],
    data.population_both,
    by.x = c ("ISO_code",     "pop_year", "age",      "gender"),
    by.y = c ("country_code", "year",     "age_from", "gender"),
    all.x = TRUE
  )

  vaccine_coverage_pop_female <- merge (
    vaccine_coverage_pop [gender == "female"],
    data.population_female,
    by.x = c ("ISO_code",     "pop_year", "age",      "gender"),
    by.y = c ("country_code", "year",     "age_from", "gender"),
    all.x = TRUE
  )

  vaccine_coverage_pop <-
    rbindlist (list (vaccine_coverage_pop_both, vaccine_coverage_pop_female),
               use.names = TRUE,
               fill      = TRUE)

  setnames (vaccine_coverage_pop, old = "value", new = c ("population") )
  vaccine_coverage_pop [, c("country_code_numeric", "country", "age_to") := NULL]

  # add vaccinated population
  vaccine_coverage_pop [, vac_population := (population * Percent_covrage/100)]

  # return vaccine coverage estimates
  return (vaccine_coverage_pop)

} # end of function -- add_population
# ------------------------------------------------------------------------------


# ------------------------------------------------------------------------------
# add deaths averted by vaccination among "all" or "under5" age groups
deaths_averted_vaccination <- function (vaccine_coverage_pop,
                                        age_group,
                                        suspension_period,
                                        psa) {

  # Estimating the health impact of vaccination against 10 pathogens in 98 low
  # and middle income countries from 2000 to 2030
  # https://www.medrxiv.org/content/10.1101/19004358v1

  # load DTP3 vaccine impact estimates
  load ("data/data.vaccine_impact_dtp.rda")

  # load vaccine impact estimates among "all" or "under5" age groups
  if (age_group == "all") {

    load ("data/data.vaccine_impact.rda")
    vaccine_impact <- rbindlist (list (data.vaccine_impact_dtp, data.vaccine_impact),
                                 use.names = TRUE)

  } else if (age_group == "under5") {

    load ("data/data.vaccine_impact_u5.rda")
    vaccine_impact <- rbindlist (list (data.vaccine_impact_dtp, data.vaccine_impact_u5),
                                 use.names = TRUE)
  }

  # add column for vaccine impact per 1000 fully vaccinated people
  vaccine_impact <- merge (
    vaccine_coverage_pop,
    vaccine_impact,
    by.x = c ("ISO_code", "Vaccine"),
    by.y = c ("country",  "vaccine"),
    all.x = TRUE
  )

  # drop redundant columns
  vaccine_impact [, c("country_name", "gavi73", "who_region") := NULL]

  # ----------------------------------------------------------------------------
  # 9 countries with no vaccine impact data from 98 vimc countries
  # Botswana, Algeria, Gabon, Equatorial Guinea, Libya
  # Mauritius, Namibia, Seychelles, South Africa
  #
  # Congo (COG) -- no vaccine impact data for menA
  # Sao Tome and Principe -- no vaccine impact data for YFV
  #
  # for countries wth no vaccine impact values, set them to the mean
  # vaccine impact in other African countries for corresponding vaccines

  for (vaccine in unique (vaccine_impact [, Vaccine]) ) {

    # estimate mid value
    vaccine_impact [is.na(mid) & Vaccine == vaccine,
                    mid := mean (vaccine_impact [!is.na (mid) & Vaccine == vaccine, mid] ) ]

    # proxy estimate of lower 95% credible interval of vaccine impact
    vaccine_impact [is.na(low) & Vaccine == vaccine,
                    low := mean (vaccine_impact [!is.na (low) & Vaccine == vaccine, low/mid], na.rm = TRUE) * mid ]

    vaccine_impact [is.na(high) & Vaccine == vaccine,
                    high := mean (vaccine_impact [!is.na (high) & Vaccine == vaccine, high/mid], na.rm = TRUE) * mid ]

    # proxy estimate of upper 95% credible interval of vaccine impact
  }
  # ----------------------------------------------------------------------------

  # adjusted impact of MCV1 and MCV2 based on measles impact
  for (value in c("mid", "low", "high")) {

    for (country_code in unique (vaccine_impact [, ISO_code]) ) {

      # Measles vaccine efficacy:
      #   85% for the first dose when vaccinating before one year of age,
      #   95% after one year of age,
      #   98% for two doses (Sudfeld et al 2010).
      #
      # Vaccines are assumed to be all or nothing, and immunity lifelong.
      #
      # Sudfeld CR, Navar AM, Halsey NA. Effectiveness of measles vaccination
      # and vitamin A treatment. Int J Epidemiol 2010;39(Suppl. 1):48-55.

      # vaccine_impact [ISO_code == country_code & Vaccine == "MCV2",
      #                 mid := (4/97) * vaccine_impact [ISO_code == country_code & Vaccine == "MCV1", mid] ]

      vaccine_impact [ISO_code == country_code & Vaccine == "MCV2",
                      as.character (as.name (value)) := (13/98) * vaccine_impact [ISO_code == country_code & Vaccine == "MCV1", eval (as.name (value))] ]

      # vaccine_impact [ISO_code == country_code & Vaccine == "MCV1",
      #                 mid := (93/97) * vaccine_impact [ISO_code == country_code & Vaccine == "MCV1", mid] ]

      vaccine_impact [ISO_code == country_code & Vaccine == "MCV1",
                      as.character (as.name (value)) := (85/98) * vaccine_impact [ISO_code == country_code & Vaccine == "MCV1", eval (as.name (value))] ]
    }
  }

  # estimate deaths averted by each vaccine in each country
  vaccine_impact [, vac_deaths_averted := (vac_population * mid / 1000) * suspension_period]

  # ----------------------------------------------------------------------------
  # minor changes to fit lognormal distribution
  #
  # drop rows with zero vaccine impact (Eswatini for RCV1)
  vaccine_impact <- vaccine_impact [!(low == 0 & mid == 0 & high == 0)]

  # add a small 0.25% value to higher bounds where higher bound equals mid value (1 row -- Egypt/HepB3)
  vaccine_impact [mid == high, high := high * 1.0025]

  # add a small value to zero values to avoid log(0) = -Inf
  vaccine_impact [low == 0, low := 1e-6]

  # add run id
  vaccine_impact [, run_id := 0]

  # set column order
  setcolorder (vaccine_impact,
               c ("run_id",
                  "Continent", "ISO_code", "Country", "WHO_Region",
                  "pop_year", "age", "gender", "population",
                  "Vaccine", "vac_year", "Percent_covrage", "vac_population",
                  "deaths_averted_1000FVP", "mid", "low", "high",
                  "vac_deaths_averted") )

  # ----------------------------------------------------------------------------
  # probabilistic sensitivity analysis

  # estimate standard error in log scale for deaths averted per 1000 vaccinated individuals
  # vaccine_impact [, log_ci_se := (log (high) - log (low)) / 3.92]

  # estimate standard deviation in log scale for deaths averted per 1000 vaccinated individuals
  # mean is also estimates in log scale (~ mid value in log scale)

  # ----------------------------------------------------------------------------

  # log-normal distribution

  vaccine_impact [, sd_log := suppressMessages (suppressWarnings (get.lnorm.par (p = c (0.025, 0.5, 0.975),
                                             q = c (low, mid, high),
                                             show.output = FALSE,
                                             plot        = FALSE) ["sdlog"]) ),
                  by = .(ISO_code, Vaccine)]

  vaccine_impact [, mean_log := suppressMessages (suppressWarnings (get.lnorm.par (p = c (0.025, 0.5, 0.975),
                                               q = c (low, mid, high),
                                               show.output = FALSE,
                                               plot        = FALSE) ["meanlog"]) ),
                  by = .(ISO_code, Vaccine)]
  # ----------------------------------------------------------------------------

  # initialise psa data table
  vaccine_impact_psa <- vaccine_impact [0, ]

  # copy vaccine impact for PSA
  for (i in 1:psa) {

    # copy data table
    dt <- copy (vaccine_impact)

    # set run id
    dt [, run_id := i]

    # add combined vaccine impact estimates to benefit risk table
    vaccine_impact_psa <- rbindlist (list (vaccine_impact_psa, dt),
                                     use.names = TRUE)
  }

  # update estimates for deaths averted by vaccination
  # note: mean_log is same value for a given ISO_code and Vaccine (similary for sd_log)
  # which is why mean (mean_log) is done to get one value
  # rlnorm will generate 'psa' number of values
  # ----------------------------------------------------------------------------

  # based on lognormal distribution

  vaccine_impact_psa [, vac_deaths_averted :=
                        vac_population * ((rlnorm (n      = psa,
                                                  meanlog = mean (mean_log),
                                                  sdlog   = mean (sd_log) )
                                           ) / 1000) * suspension_period,
                      by = .(ISO_code, Vaccine) ]
  # ----------------------------------------------------------------------------

  # # update estimates for deaths averted by vaccination
  # vaccine_impact_psa [, vac_deaths_averted :=
  #                       vac_population * ((rlnorm (n       = psa,
  #                                                  meanlog = log (mid),
  #                                                  sdlog   = log_ci_se)) / 1000) * suspension_period,
  #                     by = .(ISO_code, Vaccine) ]

  # ----------------------------------------------------------------------------

  return (vaccine_impact_psa)

} # end of function -- deaths_averted_vaccination
# ------------------------------------------------------------------------------


# ------------------------------------------------------------------------------
# Add data on household size
# ------------------------------------------------------------------------------
add_hh_size_data <- function (vaccine_impact) {

  # load UN household data
  load ("data/data.household_size.rda")

  #select household data for most recent year from DHS or IPUMS
  data.household_size <- data.household_size %>%
    dplyr::filter_at(vars(`Data source category`), all_vars(. %in% c("DHS","IPUMS"))) %>%
    dplyr::group_by(iso3_code) %>%
    dplyr::top_n(1,`Reference date (dd/mm/yyyy)`) %>%
    dplyr::mutate_at(vars(6,18,25,30),as.numeric) %>%
    dplyr::select(iso3_code                            = 1,
                  hh_size                              = 6,
                  under_20_in_hh_at_least_one_under_20 = 30,
                  percent_hh_at_least_one_under_20     = 18,
                  percent_hh_under_20_and_over_60      = 25)

  # merge data into vaccine_impact
  vaccine_impact <- merge (
    vaccine_impact,
    data.household_size,
    by.x = c ("ISO_code"),
    by.y = c ("iso3_code"),
    all.x = TRUE
  )

  # ----------------------------------------------------------------------------
  # for countries with no household size data:
  # "CPV" "DJI" "DZA" "ERI" "GNB" "GNQ" "LBY" "MRT" "MUS" "SOM" "SYC" "TUN"
  # set them to the mean value of other African countries

  household <- vaccine_impact [!is.na (hh_size),
                               lapply (.SD, mean),
                               .SDcols = c("hh_size",
                                           "under_20_in_hh_at_least_one_under_20",
                                           "percent_hh_at_least_one_under_20",
                                           "percent_hh_under_20_and_over_60"),
                               by = "ISO_code"]

  vaccine_impact [is.na (hh_size),
                  ':=' (hh_size                              = mean (household [, hh_size]),
                        under_20_in_hh_at_least_one_under_20 = mean (household [, under_20_in_hh_at_least_one_under_20]),
                        percent_hh_at_least_one_under_20     = mean (household [, percent_hh_at_least_one_under_20]),
                        percent_hh_under_20_and_over_60      = mean (household [, percent_hh_under_20_and_over_60])
                  )
                  ]
  # ----------------------------------------------------------------------------

  return (vaccine_impact)

} # end of function -- add_hh_size_data
# ------------------------------------------------------------------------------


# ------------------------------------------------------------------------------
# estimate potential deaths due to covid-19 by continuing vaccination programmes
# ------------------------------------------------------------------------------

estimate_covid_deaths <- function (vaccine_impact_psa,
                                   suspension_period,
                                   psa) {

  vaccine_covid_impact <- vaccine_impact_psa

  # timeline during which the covid deaths occur, that is
  # if EPI is suspended for this period of time (unit in year),
  # then what is the estimated number of covid deaths that are prevented
  # by suspension of EPI
  vaccine_covid_impact [, suspension_period := suspension_period]

  # ----------------------------------------------------------------------------
  # infection risk from contacts due to vaccination visits
  # using point estimates for deterministic values

  # big_t <- suspension_period * 12 * 30   # duration of period at risk of SARS-CoV-2 ** in days **
  # r0    <- 2.5                           # basic reproduction number
  # theta <- 1-(1/r0)                      # proportion of pop. infected at big_t assuming no "overshooting"
  # psi   <- 7                             # duration of infectiousness
  # n     <- 2                             # number of potentially infectious contacts on visit to clinic
  # iota1 <- 2                             # RR vacinator being infected + infectious vs community member
  # iota2 <- 0.5                           # RR of infectious vaccinator transmitting vs community member
  # p0    <- (theta * psi)/big_t           # prevalence of infectiousness amongst community members on given day
  # pv    <- p0 * iota1                    # prevalence of infectiousness amongst vaccinators on given day
  # big_n <- 5                             # av. no. of community member transmission relevant contacts per day
  # t0    <- r0/(big_n * psi)              # prob. transmission given potentially infectious community contact
  # tv    <- t0 * iota2                    # prob. transmission given potentially infectious vaccinator contact
  #
  # pe_v1_mid <- (1-((1-tv)^(2*1*pv)*(1-t0)^(2*1*n*p0)))*(1-theta) # excess household risk from 1 visit
  # pe_v2_mid <- (1-((1-tv)^(2*2*pv)*(1-t0)^(2*2*n*p0)))*(1-theta) # excess household risk from 2 visits
  # pe_v3_mid <- (1-((1-tv)^(2*3*pv)*(1-t0)^(2*3*n*p0)))*(1-theta) # excess household risk from 3 visits

  # ----------------------------------------------------------------------------
  # infection risk from contacts due to vaccination visits
  # using distributions (for probabilistic sensitivity analysis)

  # duration of period at risk of SARS-CoV-2 ** in days **
  # uniform distribution (5 months, 6 months)
  # big_t <- suspension_period * 12 * 30
  # big_t <- runif  (n = psa, min = big_t-30, max = big_t+30)
  # T <- uniform (5 months, 6 months)
  # 2020 leap year -- 366 days in the year
  big_t <- runif  (n = psa, min = 5/12 * 366, max = 6/12 * 366)

  # duration of period at risk of SARS-CoV-2 ** in year units **
  risk_period = big_t / 366

  # basic reproduction number for SARS-CoV-2
  r0    <- rgamma (n = psa, shape = 25, scale = (2.5/25))

  # proportion of SARS-CoV-2 infected population at the end of the study period
  theta <- 1 - (1/r0)

  # duration of infectiousness
  psi   <- rgamma (psa, shape = 14, scale = (7/14))

  # number of non-vaccinator contacts of child and carer during their travel to
  # the vaccine clinic and in the waiting room
  n     <- runif  (n = psa, min = 1, max = 10)

  # risk ratio of a vaccinator being infected and infectious
  # versus another community member
  iota1 <- runif  (n = psa, min = 1, max = 4)

  # risk ratio per potentially infectious contact of a vaccinator transmitting
  # versus another community member
  iota2 <- runif  (n = psa, min = 0.25, max = 1)

  # prevalence of infectious community members on any given day
  p0    <- (theta * psi) / big_t

  # prevalence of infectious vaccinators on any given day
  pv    <- iota1 * p0

  # average number of transmission relevant contacts of a community member per day
  big_n <- runif  (n = psa, min = 2, max = 10)

  # probability of transmission given potentially infectious contact for other community members
  t0    <- r0 / (big_n * psi)

  # probability of transmission given potentially infectious contact for vaccinators
  tv    <- iota2 * t0

  # ----------------------------------------------------------------------------
  # excess household risk from vaccine clinic visits (1 or 2 or 3 visits)

  pe_v1 <- (1 - ( (1 - tv)^(2*1*pv) * (1 - t0)^(2*1*p0*n) ) ) * (1 - theta)  # 1 visit
  pe_v2 <- (1 - ( (1 - tv)^(2*2*pv) * (1 - t0)^(2*2*p0*n) ) ) * (1 - theta)  # 2 visits
  pe_v3 <- (1 - ( (1 - tv)^(2*3*pv) * (1 - t0)^(2*3*p0*n) ) ) * (1 - theta)  # 3 visits

  # ----------------------------------------------------------------------------
  # infection fatality rate for child, parents (adults), and grandparents (older adults)
 
  # ifr_child        <- rgamma (n = psa, shape = 0.5163, rate = 10000)  # assume ifr for age 0-9
  # ifr_parents      <- rgamma (n = psa, shape = 3.5485, rate = 10000)  # assume ifr for age 20-29
  # ifr_grandparents <- rgamma (n = psa, shape = 14.563, rate = 737.06) # assume ifr for age 60-69
  #
  # ----------------------------------------------------------------------------
  # get shape and rate parameters for child, parents (adults), and grandparents (older adults)
  #
  # Source: Verity R, Okell LC, Dorigatti I, Winskill P, Whittaker C, Imai N, et al. 
  # Estimates of the severity of coronavirus disease 2019: a model-based analysis. 
  # Lancet Infect Dis. 2020; doi:10.1016/S1473-3099(20)30243-7
  #
  # note: these values are in percentages
  #
  # child 0-9 years -- proxy for less than 20 years old
  parameters <- suppressMessages (suppressWarnings (get.gamma.par (p = c(0.025, 0.5, 0.975), 
                                                                   q = c(0.000185, 0.00161, 0.0249), 
                                                                   show.output = FALSE,
                                                                   plot        = FALSE) ))
  shape_child <- parameters ["shape"]
  rate_child  <- parameters ["rate"]
  
  # adults 30-39 years -- proxy for 20-60 years old
  parameters <- suppressMessages (suppressWarnings (get.gamma.par (p = c(0.025, 0.5, 0.975), 
                                                                   q = c(0.0408, 0.0844, 0.185), 
                                                                   show.output = FALSE,
                                                                   plot        = FALSE) ))
  shape_parents <- parameters ["shape"]
  rate_parents  <- parameters ["rate"]
  
  # adults > 60 years
  parameters <- suppressMessages (suppressWarnings (get.gamma.par (p = c(0.025, 0.5, 0.975), 
                                                                   q = c(1.82, 3.28, 6.18), 
                                                                   show.output = FALSE,
                                                                   plot        = FALSE) ))
  shape_grandparents <- parameters ["shape"]
  rate_grandparents  <- parameters ["rate"]
  
  # infection fatality rate (percentages) for child, parents (adults), and grandparents (older adults)
  ifr_child        <- rgamma (n = psa, shape = shape_child,        rate = rate_child)         
  ifr_parents      <- rgamma (n = psa, shape = shape_parents,      rate = rate_parents)       
  ifr_grandparents <- rgamma (n = psa, shape = shape_grandparents, rate = rate_grandparents)  
  
  # change infection fatality rate (percentages) to absolute values
  ifr_child        <- ifr_child        / 100
  ifr_parents      <- ifr_parents      / 100
  ifr_grandparents <- ifr_grandparents / 100
  # ----------------------------------------------------------------------------
  

  # add a column for estimated covid-19 deaths due to continuing vaccination programmes
  # if infection is imported into household then assume the following become infected:
  # (1) the child who attends the clinic
  # (2) other children in household based on the average household members <20 years in a
  #     household with at least one child - divded by 2 to account for birth order
  # (3) 2 adults in every household (caregiver who attends clinic plus one other)
  # (4) 2 adults over 60 adjusted for the proportion of households with members <20 years that
  #     also have a household member >60 years

  vaccine_covid_impact [, child_covid_deaths        := 0]
  vaccine_covid_impact [, sibling_covid_deaths      := 0]
  vaccine_covid_impact [, parent_covid_deaths       := 0]
  vaccine_covid_impact [, grandparent_covid_deaths  := 0]
  vaccine_covid_impact [, covid_deaths              := 0]

  # also pass out psa parameter value

  vaccine_covid_impact [, param_big_t            := 0]
  vaccine_covid_impact [, param_r0               := 0]
  vaccine_covid_impact [, param_psi              := 0]
  vaccine_covid_impact [, param_n                := 0]
  vaccine_covid_impact [, param_iota1            := 0]
  vaccine_covid_impact [, param_iota2            := 0]
  vaccine_covid_impact [, param_big_n            := 0]
  vaccine_covid_impact [, param_ifr_child        := 0]
  vaccine_covid_impact [, param_ifr_parents      := 0]
  vaccine_covid_impact [, param_ifr_grandparents := 0]

  # psa runs
  for (i in 1:psa) {

    # psa parameters

    vaccine_covid_impact [run_id == i, param_big_t            := big_t            [i] ]
    vaccine_covid_impact [run_id == i, param_r0               := r0               [i] ]
    vaccine_covid_impact [run_id == i, param_n                := n                [i] ]
    vaccine_covid_impact [run_id == i, param_psi              := psi              [i] ]
    vaccine_covid_impact [run_id == i, param_iota1            := iota1            [i] ]
    vaccine_covid_impact [run_id == i, param_iota2            := iota2            [i] ]
    vaccine_covid_impact [run_id == i, param_big_n            := big_n            [i] ]
    vaccine_covid_impact [run_id == i, param_ifr_child        := ifr_child        [i] ]
    vaccine_covid_impact [run_id == i, param_ifr_parents      := ifr_parents      [i] ]
    vaccine_covid_impact [run_id == i, param_ifr_grandparents := ifr_grandparents [i] ]

    # antigens with 3 contacts
    vaccine_covid_impact [Vaccine %in% c("Diphtheria (DTP3)", "Tetanus (DTP3)", "Pertussis (DTP3)", "HepB3", "Hib3", "PCV3") & run_id == i,
                          child_covid_deaths :=
                            vac_population * risk_period [i] * pe_v3 [i] * ifr_child [i]]

    vaccine_covid_impact [Vaccine %in% c("Diphtheria (DTP3)", "Tetanus (DTP3)", "Pertussis (DTP3)", "HepB3", "Hib3", "PCV3") & run_id == i,
                          sibling_covid_deaths :=
                            vac_population * risk_period [i] * pe_v3 [i] *
                            (((under_20_in_hh_at_least_one_under_20 - 1)/2) * ifr_child [i])]

    vaccine_covid_impact [Vaccine %in% c("Diphtheria (DTP3)", "Tetanus (DTP3)", "Pertussis (DTP3)", "HepB3", "Hib3", "PCV3") & run_id == i,
                          parent_covid_deaths :=
                            vac_population * risk_period [i] * pe_v3 [i] * 2 * ifr_parents [i]]

    vaccine_covid_impact [Vaccine %in% c("Diphtheria (DTP3)", "Tetanus (DTP3)", "Pertussis (DTP3)", "HepB3", "Hib3", "PCV3") & run_id == i,
                          grandparent_covid_deaths :=
                            vac_population * risk_period [i] * pe_v3 [i] *
                            (2 * (percent_hh_under_20_and_over_60/percent_hh_at_least_one_under_20) *
                               ifr_grandparents [i])]

    vaccine_covid_impact [Vaccine %in% c("Diphtheria (DTP3)", "Tetanus (DTP3)", "Pertussis (DTP3)", "HepB3", "Hib3", "PCV3") & run_id == i,
                          covid_deaths := child_covid_deaths + sibling_covid_deaths +
                            parent_covid_deaths + grandparent_covid_deaths]



    # antigens with 2 contacts
    vaccine_covid_impact [Vaccine %in% c("RotaC","HPVfem") & run_id == i,
                          child_covid_deaths :=
                            vac_population * risk_period [i] * pe_v2 [i] * ifr_child [i]]

    vaccine_covid_impact [Vaccine %in% c("RotaC","HPVfem") & run_id == i,
                          sibling_covid_deaths :=
                            vac_population * risk_period [i] * pe_v2 [i] *
                            (((under_20_in_hh_at_least_one_under_20 - 1)/2) * ifr_child [i])]

    vaccine_covid_impact [Vaccine %in% c("RotaC","HPVfem") & run_id == i,
                          parent_covid_deaths :=
                            vac_population * risk_period [i] * pe_v2 [i] * 2 * ifr_parents [i]]

    vaccine_covid_impact [Vaccine %in% c("RotaC","HPVfem") & run_id == i,
                          grandparent_covid_deaths :=
                            vac_population * risk_period [i] * pe_v2 [i] *
                            (2 * (percent_hh_under_20_and_over_60/percent_hh_at_least_one_under_20) *
                               ifr_grandparents [i])]

    vaccine_covid_impact [Vaccine %in% c("RotaC","HPVfem") & run_id == i,
                          covid_deaths := child_covid_deaths + sibling_covid_deaths +
                            parent_covid_deaths + grandparent_covid_deaths]

    # antigens with 1 contacts
    vaccine_covid_impact [Vaccine %in% c("MCV1", "RCV1", "MCV2", "YFV", "MenA") & run_id == i,
                          child_covid_deaths :=
                            vac_population * risk_period [i] * pe_v1 [i] * ifr_child [i]]

    vaccine_covid_impact [Vaccine %in% c("MCV1", "RCV1", "MCV2", "YFV", "MenA") & run_id == i,
                          sibling_covid_deaths :=
                            vac_population * risk_period [i] * pe_v1 [i] *
                            (((under_20_in_hh_at_least_one_under_20 - 1)/2) * ifr_child [i])]

    vaccine_covid_impact [Vaccine %in% c("MCV1", "RCV1", "MCV2", "YFV", "MenA") & run_id == i,
                          parent_covid_deaths :=
                            vac_population * risk_period [i] * pe_v1 [i] * 2 * ifr_parents [i]]

    vaccine_covid_impact [Vaccine %in% c("MCV1", "RCV1", "MCV2", "YFV", "MenA") & run_id == i,
                          grandparent_covid_deaths :=
                            vac_population * risk_period [i] * pe_v1 [i] *
                            (2 * (percent_hh_under_20_and_over_60/percent_hh_at_least_one_under_20) *
                               ifr_grandparents [i])]

    vaccine_covid_impact [Vaccine %in% c("MCV1", "RCV1", "MCV2", "YFV", "MenA") & run_id == i,
                          covid_deaths := child_covid_deaths + sibling_covid_deaths +
                            parent_covid_deaths + grandparent_covid_deaths]

  }

  return (vaccine_covid_impact)

} # end of function -- estimate_covid_deaths
# ------------------------------------------------------------------------------


# ------------------------------------------------------------------------------
#  regression model for tornado diagram
tornado_regression <- function (benefit_risk_Africa,
                                vaccine_covid_impact,
                                suspension_period_string,
                                age_group,
                                impact) {

  # generate dataset for regression

  # overall vaccine deaths averted and benefit risk ratio for each psa run
  foo <- benefit_risk_Africa %>%
    dplyr::filter (Vaccine == "DTP3, HepB3, Hib3, PCV3, RotaC, MCV1, RCV1, MenA, YFV, MCV2") %>%
    dplyr::select_at (c("run_id","benefit_risk_ratio","vac_deaths_averted"))

  # # parameters for covid impact psa
  # bar <- vaccine_covid_impact %>%
  #   dplyr::group_by (run_id) %>%
  #   dplyr::select ("run_id" | starts_with ("param")) %>% distinct()

  # parameters for covid impact psa
  bar <- vaccine_covid_impact %>%
    dplyr::group_by (run_id) %>%
    dplyr::select ("run_id", starts_with ("param")) %>% distinct()

  para <- merge (foo, bar, by = "run_id") # merge
  para <- para %>% select (-1) # remove run_id

  # tornado plot using linear regression

  para_names = c("Benefit risk ratio",
                 "Child deaths averted by routine immunisation",
                 "Duration of period at risk of SARS-CoV-2",
                 "Basic reproduction number for SARS-CoV-2",
                 "Duration of infectiousness from SARS-CoV-2",
                 "Number of non-vaccinator contacts \n of child and carer",
                 # "RR of vaccinator being infected and infectious",
                 # "RR of potentially infectious contact of a vaccinator transmitting",
                 "Risk ratio of vaccinator being infected and \n infectious versus community member",
                 "Risk ratio per potentially infectious contact of \n vaccinator transmitting vs community member",
                 "Transmission relevant contacts of \n community member per day",
                 "Infection fatality rate for children",
                 "Infection fatality rate for adults",
                 "Infection fatality rate for older adults"
                 )


  # para_names = c("Benefit risk ratio",
  #                "Child deaths averted by routine immunisation",
  #                "Duration of period at risk of SARS-nCoV-2",
  #                "Basic reproduction number for SARS-nCoV-2",
  #                "Duration of infectiousness from SARS-nCoV-2",
  #                "Number of non-vaccinator contacts of child and carer",
  #                # "RR of vaccinator being infected and infectious",
  #                # "RR of potentially infectious contact of a vaccinator transmitting",
  #                "Risk ratio of vaccinator being infected and infectious vs community member",
  #                "Risk ratio per infectious contact of vaccinator transmitting vs community member",
  #                "Transmission relevant contacts of a community member per day",
  #                "Infection fatality rate for a child",
  #                "Infection fatality rate for an adult",
  #                "Infection fatality rate for an older person")

  para = subset (para,
                   para [, 1] > quantile (para [, 1], 0.025) &
                   para [, 1] < quantile (para [, 1], 0.975)
                 )

  # currently using glm

  reg.fit <- glm (para[,1] ~ para [, 2] +
                    para [, 3]  +
                    para [, 4]  +
                    para [, 5]  +
                    para [, 6]  +
                    para [, 7]  +
                    para [, 8]  +
                    para [, 9]  +
                    para [, 10] +
                    para [, 11] +
                    para [, 12],
                  family = "poisson")

  # reg.fit <- lm(para[,1] ~ para[,2]+para[,3]+para[,4]+para[,5]+para[,6]+
  #                 para[,7]+para[,8]+para[,9]+para[,10]+para[,11]+para[,12])

  coeff.regression     <- as.vector (reg.fit$coefficients [2:12])
  intercept.regression <- as.vector (reg.fit$coefficients [1])

  param.quantiles <- matrix (NA, ncol = 3, nrow = 11)
  tornado         <- matrix (NA, ncol = 2, nrow = 11)

  for (i in 2:12) {
    param.quantiles [i-1, ] <- quantile (para [, i], c(0.025, 0.975, 0.5))
  }

  median.qpp   <- intercept.regression + sum( coeff.regression * param.quantiles [,3])
  tornado [,1] <- median.qpp + (param.quantiles [,1] - param.quantiles [,3]) * coeff.regression
  tornado [,2] <- median.qpp + (param.quantiles [,2] - param.quantiles [,3]) * coeff.regression

  median.qpp <- exp (median.qpp) # comment out if using linear model
  tornado    <- exp (tornado)    # comment out if using linear model

  rownames (tornado) <- para_names [2:12]

  tornado <- t (apply (tornado, 1, sort))
  tornado <- cbind (tornado [, 1], tornado [, 2]) [order(tornado [, 2] - tornado [, 1]), ] # sort
  # tornado

  tornado  <- tornado [(length (tornado [, 1]) - 11):length(tornado [, 1]), ]
  tornado2 <- tornado - median.qpp


  # ----------------------------------------------------------------------------
  # tornado plot
  # png (file = "figures/tornado.png", width = 3300, height = 1750)
  setEPS ()
  postscript (file   = paste0 ("figures/Figure_tornado_",
                               suspension_period_string, "_suspension_",
                               age_group, "_",
                               impact, ".eps"),
              width  = 50,
              height = 26)

  layout (matrix (c(2,1,1), 1, 3, byrow = TRUE))
  par (mar = c(5, 0, 1, 1), cex = 1.2)

  barplot (tornado2 [, 1],
           width     = 1,
           horiz     = TRUE,
           offset    = median.qpp,
           space     = 0.5,
           names.arg = "",
           xlim      = c(min (tornado [, 1]), max (tornado [, 2])),
           xlab      = "Benefit risk ratio",
           col       = "#92C5DE",
           cex.axis  = 2.75,
           cex.lab   = 3.5)

  barplot (tornado2 [, 2],
           width     = 1,
           horiz     = TRUE,
           add       = TRUE,
           offset    = median.qpp,
           space     = 0.5,
           names.arg = "",
           col       = "#92C5DE",
           cex.axis  = 2.75)

  rect (20000, -0.49, 30000, length (tornado[,1])-0.5, col = "gray", density = 20)

  par (mar = c(5, 0, 1, 0))

  plot (0, 0, type="c",
        xlim  = c (0, 1),
        ylim  = c (0, length(tornado [, 1])),
        frame = FALSE,
        axes  = FALSE,
        xlab  = "",
        ylab  = "")

  text (x      = 1,
        y      = seq (length (tornado [,1]) - 0.5, 0.5),
        labels = rev (rownames (tornado)),
        pos    = 2,
        cex    = 3.55)

  dev.off ()  # save tornado plot
  # ----------------------------------------------------------------------------

  return (reg.fit)

} # end of function -- tornado_regression
# ------------------------------------------------------------------------------


# ------------------------------------------------------------------------------
# estimate benefit risk ratio
benefit_risk_ratio <- function (vaccine_covid_impact,
                                suspension_period) {

  benefit_risk <- vaccine_covid_impact

  # deaths among different groups
  #   whole household (covid_deaths);
  #   child (child_covid_deaths);
  #   sibling (sibling_covid_deaths);
  #   parent (parent_covid_deaths);
  #   grandparent (grandparent_covid_deaths)
  deaths <- c ("covid_deaths",
               "child_covid_deaths",
               "sibling_covid_deaths",
               "parent_covid_deaths",
               "grandparent_covid_deaths")

  # benefit_risk_ratios
  br_ratios <- c ("benefit_risk_ratio",
                  "child_benefit_risk_ratio",
                  "sibling_benefit_risk_ratio",
                  "parent_benefit_risk_ratio",
                  "grandparent_benefit_risk_ratio")


  # compute benefit-risk ratio across combined vaccines in same visits

  # clinical visits for vaccination among children aged 0-11 months and their adult carers = 4
  #   (3 visits for DTP3-HepB-Hib + PCV3 + RotaC) +
  #   (1 visit for MCV1 + RCV1 + MenA + YF)
  # clinical visits for vaccination among children aged 12-23 months and their adult carers = 1
  #   (1 visit for MCV2) -- single vaccine estimates already computed

  # ----------------------------------------------------------------------------
  # compute benefit-risk ratio for vaccines in the same visit
  benefit_risk_3visits_age0 <- benefit_risk [Vaccine %in% c("Diphtheria (DTP3)", "Tetanus (DTP3)", "Pertussis (DTP3)", "HepB3", "Hib3", "PCV3", "RotaC")]
  benefit_risk_1visits_age0 <- benefit_risk [Vaccine %in% c("MCV1", "RCV1", "MenA", "YFV")]

  # set vaccine name list
  benefit_risk_3visits_age0 [, Vaccine := "DTP3, HepB3, Hib3, PCV3, RotaC"]
  benefit_risk_1visits_age0 [, Vaccine := "MCV1, RCV1, MenA, YFV"]

  # add deaths averted by vaccination in the vaccine list
  benefit_risk_3visits_age0 [, vac_deaths_averted := sum (vac_deaths_averted, na.rm = T), by = .(ISO_code, run_id)]
  benefit_risk_1visits_age0 [, vac_deaths_averted := sum (vac_deaths_averted, na.rm = T), by = .(ISO_code, run_id)]

  # set covid deaths to the maximum estimate in the vaccine list
  # benefit_risk_3visits_age0 [, covid_deaths := max (covid_deaths), by = "ISO_code"]
  # benefit_risk_1visits_age0 [, covid_deaths := max (covid_deaths), by = "ISO_code"]

  for (death in deaths) {
    benefit_risk_3visits_age0 [, as.character (as.name (death)) := max (eval (as.name (death))), by = .(ISO_code, run_id)]
    benefit_risk_1visits_age0 [, as.character (as.name (death)) := max (eval (as.name (death))), by = .(ISO_code, run_id)]
  }

  # sample 1 row per country for combined vaccine impact estimates
  benefit_risk_3visits_age0 <- benefit_risk_3visits_age0 %>% group_by (ISO_code, run_id)
  benefit_risk_3visits_age0 <- sample_n (benefit_risk_3visits_age0, 1)

  benefit_risk_1visits_age0 <- benefit_risk_1visits_age0 %>% group_by (ISO_code, run_id)
  benefit_risk_1visits_age0 <- sample_n (benefit_risk_1visits_age0, 1)

  # add combined vaccine impact estimates to benefit risk table
  benefit_risk <-
    rbindlist (list (benefit_risk,
                     benefit_risk_3visits_age0,
                     benefit_risk_1visits_age0),
               use.names = TRUE,
               fill      = TRUE)

  # ----------------------------------------------------------------------------
  # compute benefit-risk ratio across EPI vaccines
  benefit_risk_EPI <- benefit_risk [Vaccine %in% c("DTP3, HepB3, Hib3, PCV3, RotaC",
                                                   "MCV1, RCV1, MenA, YFV",
                                                   "MCV2")]

  # set vaccine name list
  benefit_risk_EPI [, Vaccine := "DTP3, HepB3, Hib3, PCV3, RotaC, MCV1, RCV1, MenA, YFV, MCV2"]

  # add deaths averted by vaccination in the vaccine list
  benefit_risk_EPI [, vac_deaths_averted := sum (vac_deaths_averted, na.rm = T), by = .(ISO_code, run_id)]

  # add covid deaths in the vaccine list
  for (death in deaths) {
    benefit_risk_EPI [, as.character (as.name (death)) := sum (eval (as.name (death)), na.rm = T), by = .(ISO_code, run_id)]
  }

  # sample 1 row per country for combined vaccine impact estimates
  benefit_risk_EPI <- benefit_risk_EPI %>% group_by (ISO_code, run_id)
  benefit_risk_EPI <- sample_n (benefit_risk_EPI, 1)

  # add combined vaccine impact estimates to benefit risk table
  benefit_risk <-
    rbindlist (list (benefit_risk,
                     benefit_risk_EPI),
               use.names = TRUE,
               fill      = TRUE)
  # ----------------------------------------------------------------------------

  # estimate benefit-risk ratios among different groups
  for (i in 1:5) {

    benefit_risk [, as.character (as.name (br_ratios [i])) :=
                    vac_deaths_averted / eval (as.name (deaths [i]) ) ]
  }

  return (benefit_risk)

} # end of function -- benefit_risk_ratio
# ------------------------------------------------------------------------------


# ------------------------------------------------------------------------------
# estimate benefit risk ratio for the whole continent of Africa
benefit_risk_ratio_Africa <- function (vaccine_covid_impact,
                                       suspension_period) {

  benefit_risk_Africa <- vaccine_covid_impact

  benefit_risk_Africa <-
    benefit_risk_Africa [, list (vac_deaths_averted       = sum (vac_deaths_averted,       na.rm = T),
                                 child_covid_deaths       = sum (child_covid_deaths,       na.rm = T),
                                 sibling_covid_deaths     = sum (sibling_covid_deaths,     na.rm = T),
                                 parent_covid_deaths      = sum (parent_covid_deaths,      na.rm = T),
                                 grandparent_covid_deaths = sum (grandparent_covid_deaths, na.rm = T),
                                 covid_deaths             = sum (covid_deaths,             na.rm = T)
    ),
    by = .(run_id, Continent, Vaccine) ]

  # deaths among different groups
  #   whole household (covid_deaths);
  #   child (child_covid_deaths);
  #   sibling (sibling_covid_deaths);
  #   parent (parent_covid_deaths);
  #   grandparent (grandparent_covid_deaths)
  deaths <- c ("covid_deaths",
               "child_covid_deaths",
               "sibling_covid_deaths",
               "parent_covid_deaths",
               "grandparent_covid_deaths")

  # benefit_risk_ratios
  br_ratios <- c ("benefit_risk_ratio",
                  "child_benefit_risk_ratio",
                  "sibling_benefit_risk_ratio",
                  "parent_benefit_risk_ratio",
                  "grandparent_benefit_risk_ratio")


  # compute benefit-risk ratio across combined vaccines in same visits

  # clinical visits for vaccination among children aged 0-11 months and their adult carers = 4
  #   (3 visits for DTP3-HepB-Hib + PCV3 + RotaC) +
  #   (1 visit for MCV1 + RCV1 + MenA + YF)
  # clinical visits for vaccination among children aged 12-23 months and their adult carers = 1
  #   (1 visit for MCV2) -- single vaccine estimates already computed

  # ----------------------------------------------------------------------------
  # compute benefit-risk ratio for vaccines in the same visit
  benefit_risk_3visits_age0 <- benefit_risk_Africa [Vaccine %in% c("Diphtheria (DTP3)", "Tetanus (DTP3)", "Pertussis (DTP3)", "HepB3", "Hib3", "PCV3", "RotaC")]
  benefit_risk_1visits_age0 <- benefit_risk_Africa [Vaccine %in% c("MCV1", "RCV1", "MenA", "YFV")]

  # set vaccine name list
  benefit_risk_3visits_age0 [, Vaccine := "DTP3, HepB3, Hib3, PCV3, RotaC"]
  benefit_risk_1visits_age0 [, Vaccine := "MCV1, RCV1, MenA, YFV"]

  # add deaths averted by vaccination in the vaccine list
  benefit_risk_3visits_age0 [, vac_deaths_averted := sum (vac_deaths_averted, na.rm = T), by = .(run_id)]
  benefit_risk_1visits_age0 [, vac_deaths_averted := sum (vac_deaths_averted, na.rm = T), by = .(run_id)]

  # set covid deaths to the maximum estimate in the vaccine list
  # benefit_risk_3visits_age0 [, covid_deaths := max (covid_deaths), by = "ISO_code"]
  # benefit_risk_1visits_age0 [, covid_deaths := max (covid_deaths), by = "ISO_code"]

  for (death in deaths) {
    benefit_risk_3visits_age0 [, as.character (as.name (death)) := max (eval (as.name (death))), by = .(run_id)]
    benefit_risk_1visits_age0 [, as.character (as.name (death)) := max (eval (as.name (death))), by = .(run_id)]
  }

  # sample 1 row per country for combined vaccine impact estimates
  benefit_risk_3visits_age0 <- benefit_risk_3visits_age0 %>% group_by (run_id)
  benefit_risk_3visits_age0 <- sample_n (benefit_risk_3visits_age0, 1)

  benefit_risk_1visits_age0 <- benefit_risk_1visits_age0 %>% group_by (run_id)
  benefit_risk_1visits_age0 <- sample_n (benefit_risk_1visits_age0, 1)

  # add combined vaccine impact estimates to benefit risk table
  benefit_risk_Africa <-
    rbindlist (list (benefit_risk_Africa,
                     benefit_risk_3visits_age0,
                     benefit_risk_1visits_age0),
               use.names = TRUE,
               fill      = TRUE)

  # ----------------------------------------------------------------------------
  # compute benefit-risk ratio across EPI vaccines
  benefit_risk_EPI <- benefit_risk_Africa [Vaccine %in% c("DTP3, HepB3, Hib3, PCV3, RotaC",
                                                          "MCV1, RCV1, MenA, YFV",
                                                          "MCV2")]

  # set vaccine name list
  benefit_risk_EPI [, Vaccine := "DTP3, HepB3, Hib3, PCV3, RotaC, MCV1, RCV1, MenA, YFV, MCV2"]

  # add deaths averted by vaccination in the vaccine list
  benefit_risk_EPI [, vac_deaths_averted := sum (vac_deaths_averted, na.rm = T), by = .(run_id)]

  # add covid deaths in the vaccine list
  for (death in deaths) {
    benefit_risk_EPI [, as.character (as.name (death)) := sum (eval (as.name (death)), na.rm = T), by = .(run_id)]
  }

  # sample 1 row per country for combined vaccine impact estimates
  benefit_risk_EPI <- benefit_risk_EPI %>% group_by (run_id)
  benefit_risk_EPI <- sample_n (benefit_risk_EPI, 1)

  # add combined vaccine impact estimates to benefit risk table
  benefit_risk_Africa <-
    rbindlist (list (benefit_risk_Africa,
                     benefit_risk_EPI),
               use.names = TRUE,
               fill      = TRUE)
  # ----------------------------------------------------------------------------

  # estimate benefit-risk ratios among different groups
  for (i in 1:5) {

    benefit_risk_Africa [, as.character (as.name (br_ratios [i])) :=
                           vac_deaths_averted / eval (as.name (deaths [i]) ) ]
  }

  return (benefit_risk_Africa)

} # end of function -- benefit_risk_ratio_Africa
# ------------------------------------------------------------------------------


# ------------------------------------------------------------------------------
# estimate benefit risk ratio -- summary estimates (median, credible intervals)
benefit_risk_ratio_summary <- function (benefit_risk) {

  benefit_risk_summary <- benefit_risk

  # estimate benefit-risk ratios among different groups
  # median and credible intervals
  benefit_risk_summary <-
    benefit_risk_summary [, list (benefit_risk_ratio                  = quantile (benefit_risk_ratio,             0.5,   na.rm = T),
                                  benefit_risk_ratio_low              = ci       (benefit_risk_ratio, ci = 0.95, method = "HDI")$CI_low,
                                  benefit_risk_ratio_high             = ci       (benefit_risk_ratio, ci = 0.95, method = "HDI")$CI_high,

                                  # benefit_risk_ratio_low              = quantile (benefit_risk_ratio,             0.025, na.rm = T),
                                  # benefit_risk_ratio_high             = quantile (benefit_risk_ratio,             0.975, na.rm = T),

                                  child_benefit_risk_ratio            = quantile (child_benefit_risk_ratio,       0.5,   na.rm = T),
                                  child_benefit_risk_ratio_low        = ci       (child_benefit_risk_ratio, ci = 0.95, method = "HDI")$CI_low,
                                  child_benefit_risk_ratio_high       = ci       (child_benefit_risk_ratio, ci = 0.95, method = "HDI")$CI_high,

                                  # child_benefit_risk_ratio_low        = quantile (child_benefit_risk_ratio,       0.025, na.rm = T),
                                  # child_benefit_risk_ratio_high       = quantile (child_benefit_risk_ratio,       0.975, na.rm = T),

                                  sibling_benefit_risk_ratio          = quantile (sibling_benefit_risk_ratio,     0.5,   na.rm = T),
                                  sibling_benefit_risk_ratio_low      = ci       (sibling_benefit_risk_ratio, ci = 0.95, method = "HDI")$CI_low,
                                  sibling_benefit_risk_ratio_high     = ci       (sibling_benefit_risk_ratio, ci = 0.95, method = "HDI")$CI_high,

                                  # sibling_benefit_risk_ratio_low      = quantile (sibling_benefit_risk_ratio,     0.025, na.rm = T),
                                  # sibling_benefit_risk_ratio_high     = quantile (sibling_benefit_risk_ratio,     0.975, na.rm = T),

                                  parent_benefit_risk_ratio           = quantile (parent_benefit_risk_ratio,      0.5,   na.rm = T),
                                  parent_benefit_risk_ratio_low       = ci       (parent_benefit_risk_ratio, ci = 0.95, method = "HDI")$CI_low,
                                  parent_benefit_risk_ratio_high      = ci       (parent_benefit_risk_ratio, ci = 0.95, method = "HDI")$CI_high,

                                  # parent_benefit_risk_ratio_low       = quantile (parent_benefit_risk_ratio,      0.025, na.rm = T),
                                  # parent_benefit_risk_ratio_high      = quantile (parent_benefit_risk_ratio,      0.975, na.rm = T),

                                  grandparent_benefit_risk_ratio      = quantile (grandparent_benefit_risk_ratio, 0.5,   na.rm = T),
                                  grandparent_benefit_risk_ratio_low  = ci       (grandparent_benefit_risk_ratio, ci = 0.95, method = "HDI")$CI_low,
                                  grandparent_benefit_risk_ratio_high = ci       (grandparent_benefit_risk_ratio, ci = 0.95, method = "HDI")$CI_high,

                                  # grandparent_benefit_risk_ratio_low  = quantile (grandparent_benefit_risk_ratio, 0.025, na.rm = T),
                                  # grandparent_benefit_risk_ratio_high = quantile (grandparent_benefit_risk_ratio, 0.975, na.rm = T),

                                  vac_deaths_averted                  = quantile (vac_deaths_averted,             0.5,   na.rm = T),
                                  vac_deaths_averted_low              = ci       (vac_deaths_averted, ci = 0.95, method = "HDI")$CI_low,
                                  vac_deaths_averted_high             = ci       (vac_deaths_averted, ci = 0.95, method = "HDI")$CI_high,

                                  # vac_deaths_averted_low              = quantile (vac_deaths_averted,             0.025, na.rm = T),
                                  # vac_deaths_averted_high             = quantile (vac_deaths_averted,             0.975, na.rm = T),

                                  covid_deaths                         = quantile (covid_deaths,                  0.5,   na.rm = T),
                                  covid_deaths_low                     = ci       (covid_deaths, ci = 0.95, method = "HDI")$CI_low,
                                  covid_deaths_high                    = ci       (covid_deaths, ci = 0.95, method = "HDI")$CI_high,

                                  # covid_deaths_low                     = quantile (covid_deaths,                  0.025, na.rm = T),
                                  # covid_deaths_high                    = quantile (covid_deaths,                  0.975, na.rm = T),

                                  child_covid_deaths                  = quantile (child_covid_deaths,             0.5,   na.rm = T),
                                  child_covid_deaths_low              = ci       (child_covid_deaths, ci = 0.95, method = "HDI")$CI_low,
                                  child_covid_deaths_high             = ci       (child_covid_deaths, ci = 0.95, method = "HDI")$CI_high,

                                  # child_covid_deaths_low              = quantile (child_covid_deaths,             0.025, na.rm = T),
                                  # child_covid_deaths_high             = quantile (child_covid_deaths,             0.975, na.rm = T),

                                  sibling_covid_deaths                = quantile (sibling_covid_deaths,           0.5,   na.rm = T),
                                  sibling_covid_deaths_low            = ci       (sibling_covid_deaths, ci = 0.95, method = "HDI")$CI_low,
                                  sibling_covid_deaths_high           = ci       (sibling_covid_deaths, ci = 0.95, method = "HDI")$CI_high,

                                  # sibling_covid_deaths_low            = quantile (sibling_covid_deaths,           0.025, na.rm = T),
                                  # sibling_covid_deaths_high           = quantile (sibling_covid_deaths,           0.975, na.rm = T),

                                  parent_covid_deaths                  = quantile (parent_covid_deaths,           0.5,   na.rm = T),
                                  parent_covid_deaths_low              = ci       (parent_covid_deaths, ci = 0.95, method = "HDI")$CI_low,
                                  parent_covid_deaths_high             = ci       (parent_covid_deaths, ci = 0.95, method = "HDI")$CI_high,

                                  # parent_covid_deaths_low              = quantile (parent_covid_deaths,           0.025, na.rm = T),
                                  # parent_covid_deaths_high             = quantile (parent_covid_deaths,           0.975, na.rm = T),

                                  grandparent_covid_deaths             = quantile (grandparent_covid_deaths,      0.5,   na.rm = T),
                                  grandparent_covid_deaths_low         = ci       (grandparent_covid_deaths, ci = 0.95, method = "HDI")$CI_low,
                                  grandparent_covid_deaths_high        = ci       (grandparent_covid_deaths, ci = 0.95, method = "HDI")$CI_high

                                  # grandparent_covid_deaths_low         = quantile (grandparent_covid_deaths,      0.025, na.rm = T),
                                  # grandparent_covid_deaths_high        = quantile (grandparent_covid_deaths,      0.975, na.rm = T)

                                  ),
                          by = .(ISO_code, Vaccine) ]

  return (benefit_risk_summary)

} # end of function -- benefit_risk_ratio_summary
# ------------------------------------------------------------------------------


# ------------------------------------------------------------------------------
# generate map of benefit risk ratio
benefit_risk_ratio_map <- function (benefit_risk_summary,
                                    suspension_period_string,
                                    age_group,
                                    impact) {
  # file to save plots
  pdf (paste0 ("figures/benefit_risk_ratio_maps_",
               suspension_period_string, "_suspension_",
               age_group, "_",
               impact, ".pdf"))

  # ggplot theme
  theme_set (theme_bw())

  # benefit_risk_ratios
  br_ratios <- c ("benefit_risk_ratio",
                  "child_benefit_risk_ratio",
                  "sibling_benefit_risk_ratio",
                  "parent_benefit_risk_ratio",
                  "grandparent_benefit_risk_ratio")

  # benefit_risk_ratio titles
  br_ratio_title <- c ("Benefit-risk ratio (household)",
                       "Benefit-risk ratio (vaccinated children)",
                       "Benefit-risk ratio (siblings aged below 20 years)",
                       "Benefit-risk ratio (adults aged 20-60 years)",
                       "Benefit-risk ratio (older adults aged above 60 years)"
                       )

  i <- 0  # counter for benefit_risk_ratio titles

    # vaccination impact timeline -- lifetime or under 5-year-old children
  if (age_group == "all") {
    vaccine_impact_timeline <- "lifetime"
  } else if (age_group == "under5") {
    vaccine_impact_timeline <- "under 5-year-old children"
  }

  # map tutorial
  # https://www.r-spatial.org/r/2018/10/25/ggplot2-sf.html
  africa <- ne_countries (continent   = 'africa',
                          scale       = "medium",
                          returnclass = "sf")
  setDT  (africa)
  setkey (africa, sov_a3)

  # list of vaccines
  vaccines <- unique (benefit_risk$Vaccine)

  # benefit-risk ratios for different groups
  for (br_ratio in br_ratios) {

    i <- i + 1  # counter for benefit_risk_ratio titles

    # generate benefit-risk ratio maps for different vaccines
    for (vaccine in vaccines) {

      # combine tables to add geometry
      dt <- merge (x    = benefit_risk_summary [Vaccine == vaccine],
                   y    = africa,
                   by.x = "ISO_code",
                   by.y = "iso_a3",
                   all  = T )

      # copy data for Somalia to Somaliland
      dt [sov_a3 == "SOL",
          c(as.character (as.name (br_ratio))) := dt [ISO_code == "SOM", eval (as.name (br_ratio))]
          ]

      # map of benefit-risk ratio for different vaccines
      p <- ggplot (data = dt) +
        geom_sf (aes (fill = eval (as.name (br_ratio)), geometry = geometry)) +
        # scale_fill_viridis_c (option = "plasma", direction = -1, limits = c(0, NA), na.value = "grey80") +
        scale_fill_gradient2 (midpoint = 0,
                              low = "red",
                              mid = "white",
                              high = "blue",
                              na.value = "grey80",
                              limits = c (0.05, 700),
                              trans = "log10",
                              breaks = c(0.1, 1, 10, 100)) +
                              # breaks = c(0.2, 1, 5, 10, 50, 100, 500)) +


        # scale_fill_gradient2 (midpoint = 0,
        #                       low = "red",
        #                       mid = "white",
        #                       high = "blue",
        #                       na.value = "grey70",
        #                       trans = "log",
        #                       limits = c (0.5, NA),
        #                       breaks = c(0, 0.5, 1, 5, 10, 50, 100)) +

        # ----------------------------------------------------------------------
        labs (title    = paste0 (br_ratio_title [i], " - Deaths averted by vaccination per excess COVID-19 death"),

        # uncomment this part to generate figures for paper
        subtitle = paste0 (vaccine),

        # uncomment this part to generate figures for appendix
        # subtitle = paste0 (vaccine, "\n EPI suspension period: ", suspension_period_string, " / vaccine impact: ", vaccine_impact_timeline),
        # ----------------------------------------------------------------------

              fill     = "benefit-risk ratio") +
        theme (axis.text.x      = element_blank(), axis.ticks = element_blank()) +
        theme (axis.text.y      = element_blank(), axis.ticks = element_blank()) +
        theme (panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
        theme (plot.title       = element_text (size = 9)) +
        theme (plot.subtitle    = element_text (size = 9)) +
        theme (legend.title     = element_text (size = 10)) +
        theme (legend.text      = element_text (size = 7))


      print (p)


      # --------------------------------------------------------------------------
      # save figure in eps format for paper
      if ((br_ratio == "benefit_risk_ratio") &
          (vaccine == "DTP3, HepB3, Hib3, PCV3, RotaC, MCV1, RCV1, MenA, YFV, MCV2")) {

        p <- p + labs (title = NULL, subtitle = NULL)

        ggsave (filename = paste0 ("figures/Figure_benefit-risk-ratio_EPI_",
                                   suspension_period_string, "_suspension_",
                                   age_group, "_",
                                   impact, ".eps"),
                plot = p)
        # width = 6, height = 9.5, units="in")
      }
      # --------------------------------------------------------------------------

    } # end -- for (vaccine in vaccines)

  } # end -- for (br_ratio in br_ratios)

  dev.off ()  # close plots file

  return ()

} # end of function -- benefit_risk_ratio_map
# ------------------------------------------------------------------------------


# ------------------------------------------------------------------------------
# save benefit-risk results
save_benefit_risk_results <- function (benefit_risk,
                                       benefit_risk_summary,
                                       benefit_risk_summary_Africa,
                                       suspension_period,
                                       suspension_period_string,
                                       age_group,
                                       impact) {

  # ----------------------------------------------------------------------------
  # save benefit-risk results of all psa runs
  fwrite (benefit_risk, file = paste0 ("tables/benefit_risk_results_",
                                       suspension_period_string,
                                       "_suspension_",
                                       age_group, "_",
                                       impact,
                                       ".csv") )
  # ----------------------------------------------------------------------------

  # ----------------------------------------------------------------------------
  # save benefit-risk results summary -- country level
  fwrite (benefit_risk_summary , file = paste0 ("tables/benefit_risk_summary_results_",
                                                suspension_period_string,
                                                "_suspension_",
                                                age_group, "_",
                                                impact,
                                                ".csv") )

  # save benefit-risk results summary -- country level -- for paper

  # extract benefit-risk results for
  # DTP3, HepB3, Hib3, PCV3, RotaC, MCV1, RCV1, MenA, YFV, MCV2
  dt <- benefit_risk_summary [Vaccine == "DTP3, HepB3, Hib3, PCV3, RotaC, MCV1, RCV1, MenA, YFV, MCV2"]

  # round off to 1 decimal points
  dt <- dt [, lapply(.SD, round, 0),
            .SDcols = c("benefit_risk_ratio",
                        "benefit_risk_ratio_low",
                        "benefit_risk_ratio_high",

                        "child_benefit_risk_ratio",
                        "child_benefit_risk_ratio_low",
                        "child_benefit_risk_ratio_high",

                        "sibling_benefit_risk_ratio",
                        "sibling_benefit_risk_ratio_low",
                        "sibling_benefit_risk_ratio_high",

                        "parent_benefit_risk_ratio",
                        "parent_benefit_risk_ratio_low",
                        "parent_benefit_risk_ratio_high",

                        "grandparent_benefit_risk_ratio",
                        "grandparent_benefit_risk_ratio_low",
                        "grandparent_benefit_risk_ratio_high"
            ),
            by = .(Country)]

  dt [, ':=' ('Household' = paste0 (comma (benefit_risk_ratio), " (",
                                    comma (benefit_risk_ratio_low), "-",
                                    comma (benefit_risk_ratio_high), ")"),

              'Vaccinated children' = paste0 (comma (child_benefit_risk_ratio), " (",
                                              comma (child_benefit_risk_ratio_low), "-",
                                              comma (child_benefit_risk_ratio_high), ")"),

              'Siblings' = paste0 (comma (sibling_benefit_risk_ratio), " (",
                                   comma (sibling_benefit_risk_ratio_low), "-",
                                   comma (sibling_benefit_risk_ratio_high), ")"),

              'Parents' = paste0 (comma (parent_benefit_risk_ratio), " (",
                                  comma (parent_benefit_risk_ratio_low), "-",
                                  comma (parent_benefit_risk_ratio_high), ")"),

              'Grandparents' = paste0 (comma (grandparent_benefit_risk_ratio), " (",
                                       comma (grandparent_benefit_risk_ratio_low), "-",
                                       comma (grandparent_benefit_risk_ratio_high), ")")
              ) ]

  # drop non-requisite columns
  dt [, c("benefit_risk_ratio",             "benefit_risk_ratio_low",             "benefit_risk_ratio_high",
          "child_benefit_risk_ratio",       "child_benefit_risk_ratio_low",       "child_benefit_risk_ratio_high",
          "sibling_benefit_risk_ratio",     "sibling_benefit_risk_ratio_low",     "sibling_benefit_risk_ratio_high",
          "parent_benefit_risk_ratio",      "parent_benefit_risk_ratio_low",      "parent_benefit_risk_ratio_high",
          "grandparent_benefit_risk_ratio", "grandparent_benefit_risk_ratio_low", "grandparent_benefit_risk_ratio_high")
      := NULL]

  fwrite (dt,
          paste0 ("tables/Table_benefit_risk_summary_results_",
                  suspension_period_string,
                  "_suspension_",
                  age_group, "_",
                  impact,
                  ".csv"),
          col.names = T, row.names = F)

  # ----------------------------------------------------------------------------

  # ----------------------------------------------------------------------------
  # save benefit-risk results summary -- continent level
  fwrite (benefit_risk_summary_Africa , file = paste0 ("tables/benefit_risk_summary_Africa_results_",
                                                       suspension_period_string,
                                                       "_suspension_",
                                                       age_group, "_",
                                                       impact,
                                                       ".csv") )

  # save benefit-risk results summary -- continent level -- for paper
  # round off to 1 decimal points
  dt <- benefit_risk_summary_Africa [, lapply(.SD, round, 1),
                                     .SDcols = c("benefit_risk_ratio",
                                                 "benefit_risk_ratio_low",
                                                 "benefit_risk_ratio_high",

                                                 "child_benefit_risk_ratio",
                                                 "child_benefit_risk_ratio_low",
                                                 "child_benefit_risk_ratio_high",

                                                 "sibling_benefit_risk_ratio",
                                                 "sibling_benefit_risk_ratio_low",
                                                 "sibling_benefit_risk_ratio_high",

                                                 "parent_benefit_risk_ratio",
                                                 "parent_benefit_risk_ratio_low",
                                                 "parent_benefit_risk_ratio_high",

                                                 "grandparent_benefit_risk_ratio",
                                                 "grandparent_benefit_risk_ratio_low",
                                                 "grandparent_benefit_risk_ratio_high"
                                                 ),
                                     by = .(Vaccine)]

  dt [, ':=' ('Household' = paste0 (comma (benefit_risk_ratio), " (",
                                    comma (benefit_risk_ratio_low), "-",
                                    comma (benefit_risk_ratio_high), ")"),

              'Vaccinated children' = paste0 (comma (child_benefit_risk_ratio), " (",
                                              comma (child_benefit_risk_ratio_low), "-",
                                              comma (child_benefit_risk_ratio_high), ")"),

              'Siblings' = paste0 (comma (sibling_benefit_risk_ratio), " (",
                                   comma (sibling_benefit_risk_ratio_low), "-",
                                   comma (sibling_benefit_risk_ratio_high), ")"),

              'Parents' = paste0 (comma (parent_benefit_risk_ratio), " (",
                                  comma (parent_benefit_risk_ratio_low), "-",
                                  comma (parent_benefit_risk_ratio_high), ")"),

              'Grandparents' = paste0 (comma (grandparent_benefit_risk_ratio), " (",
                                       comma (grandparent_benefit_risk_ratio_low), "-",
                                       comma (grandparent_benefit_risk_ratio_high), ")")
              ) ]

  # drop non-requisite columns
  dt [, c("benefit_risk_ratio",             "benefit_risk_ratio_low",             "benefit_risk_ratio_high",
          "child_benefit_risk_ratio",       "child_benefit_risk_ratio_low",       "child_benefit_risk_ratio_high",
          "sibling_benefit_risk_ratio",     "sibling_benefit_risk_ratio_low",     "sibling_benefit_risk_ratio_high",
          "parent_benefit_risk_ratio",      "parent_benefit_risk_ratio_low",      "parent_benefit_risk_ratio_high",
          "grandparent_benefit_risk_ratio", "grandparent_benefit_risk_ratio_low", "grandparent_benefit_risk_ratio_high")
      := NULL]

  fwrite (dt,
          paste0 ("tables/Table_benefit_risk_summary_Africa_results_",
                  suspension_period_string,
                  "_suspension_",
                  age_group, "_",
                  impact,
                  ".csv"),
          col.names = T, row.names = F)
  # ----------------------------------------------------------------------------

  # ----------------------------------------------------------------------------
  # save -- vaccine antigen specific benefits and risks
  dt <- benefit_risk_summary_Africa [, lapply(.SD, round, 1),
                                     .SDcols = c("benefit_risk_ratio",
                                                 "benefit_risk_ratio_low",
                                                 "benefit_risk_ratio_high",

                                                 "vac_deaths_averted",
                                                 "vac_deaths_averted_low",
                                                 "vac_deaths_averted_high",

                                                 "covid_deaths",
                                                 "covid_deaths_low",
                                                 "covid_deaths_high"
                                     ),
                                     by = .(Vaccine)]

  # add vaccination schedule
  dt [, 'Vaccination schedule' := "6, 10, 14 weeks"]
  dt [Vaccine == "RotaC", 'Vaccination schedule' := "6, 10 weeks"]
  dt [Vaccine %in% c("MCV1", "RCV1", "MenA", "YFV"), 'Vaccination schedule' := "9 months"]
  dt [Vaccine == "MCV2", 'Vaccination schedule' := "15-18 months"]
  dt [Vaccine == c("MCV1, RCV1, MenA, YFV"), 'Vaccination schedule' := "9 months"]
  dt [Vaccine == c("DTP3, HepB3, Hib3, PCV3, RotaC, MCV1, RCV1, MenA, YFV, MCV2"), 'Vaccination schedule' := "6, 10, 14 weeks; 9 months; 15-18 months"]

  # order
  dt [, vaccine_order := c(1, 4, 5, 8, 12, 6, 3, 9, 7, 2,
                           11, 10, 13, 14, 15)]
  dt <- dt [order (vaccine_order),]

  dt [, ':=' ('Deaths averted by vaccination' = paste0 (comma (vac_deaths_averted), " (",
                                                        comma (vac_deaths_averted_low), "-",
                                                        comma (vac_deaths_averted_high), ")"),

              'Excess Covid-19 deaths' = paste0 (comma (covid_deaths), " (",
                                                 comma (covid_deaths_low), "-",
                                                 comma (covid_deaths_high), ")"),

              'Benefit-risk ratio' = paste0 (comma (benefit_risk_ratio), " (",
                                             comma (benefit_risk_ratio_low), "-",
                                             comma (benefit_risk_ratio_high), ")")
              ) ]

  # keep requisite columns
  dt <- dt [, c("Vaccine",
                "Vaccination schedule",
                "Deaths averted by vaccination",
                "Excess Covid-19 deaths",
                "Benefit-risk ratio")]

  fwrite (dt,
          paste0 ("tables/Table_benefits_risks_benefit_risk_ratios_summary_Africa_results_",
                  suspension_period_string,
                  "_suspension_",
                  age_group, "_",
                  impact,
                  ".csv"),
          col.names = T, row.names = F)


  # ----------------------------------------------------------------------------

  # ----------------------------------------------------------------------------
  # save -- combined vaccine benefits and risks at country level
  dt <- benefit_risk_summary [Vaccine == "DTP3, HepB3, Hib3, PCV3, RotaC, MCV1, RCV1, MenA, YFV, MCV2",
                              lapply (.SD, round, 1),
                              .SDcols = c("benefit_risk_ratio",
                                          "benefit_risk_ratio_low",
                                          "benefit_risk_ratio_high",

                                          "vac_deaths_averted",
                                          "vac_deaths_averted_low",
                                          "vac_deaths_averted_high",

                                          "covid_deaths",
                                          "covid_deaths_low",
                                          "covid_deaths_high"
                              ),
                              by = .(Country)]

  dt [, ':=' ('Deaths averted by vaccination' = paste0 (comma (vac_deaths_averted), " (",
                                                        comma (vac_deaths_averted_low), "-",
                                                        comma (vac_deaths_averted_high), ")"),

              'Excess Covid-19 deaths' = paste0 (comma (covid_deaths), " (",
                                                 comma (covid_deaths_low), "-",
                                                 comma (covid_deaths_high), ")"),

              'Benefit-risk ratio' = paste0 (comma (benefit_risk_ratio), " (",
                                             comma (benefit_risk_ratio_low), "-",
                                             comma (benefit_risk_ratio_high), ")")
              ) ]

  # keep requisite columns
  dt <- dt [, c("Country",
                "Deaths averted by vaccination",
                "Excess Covid-19 deaths",
                "Benefit-risk ratio")]

  fwrite (dt,
          paste0 ("tables/Table_benefits_risks_benefit_risk_ratios_summary_country_level_results_",
                  suspension_period_string,
                  "_suspension_",
                  age_group, "_",
                  impact,
                  ".csv"),
          col.names = T, row.names = F)


  # ----------------------------------------------------------------------------


  return ()

} # end of function -- save_benefit_risk_results
# ------------------------------------------------------------------------------


# ------------------------------------------------------------------------------
# adjust vaccine impact estimates for pessimistic measles scenario
# ------------------------------------------------------------------------------
measles_scenario <- function (vaccine_impact_psa,
                              suspension_period,
                              outbreak_chance,
                              reduced_transmission) {

  # reduced transmission due to social distancing will increase the inter-pandemic
  # period. Hence it will decrease the chance of an outbreak - hence we could
  # assume that it will further half the chance of an outbreak

  # time since vaccination to 5 years of age
  # mcv1 vaccination at 9 months of age
  # mcv2 vaccination at 15-18 months of age
  # impact_period_mcv1 <- (60 - 9)         / 12
  # impact_period_mcv2 <- (60 - (15+18)/2) / 12

  # adjustment factors of vaccine impact
  # adjustment_mcv1 = (suspension_period / impact_period_mcv1) * outbreak_chance
  # adjustment_mcv2 = (suspension_period / impact_period_mcv2) * outbreak_chance
  # adjustment_mcv1 = outbreak_chance * reduced_transmission
  # adjustment_mcv2 = outbreak_chance * reduced_transmission
  adjustment_mcv <- outbreak_chance * reduced_transmission

  # adjust vaccine impact
  vaccine_impact_psa [!(Vaccine == "MCV1" | Vaccine == "MCV2"),
                      vac_deaths_averted := 0]

  vaccine_impact_psa [Vaccine == "MCV1",
                      vac_deaths_averted := vac_deaths_averted * adjustment_mcv]

  vaccine_impact_psa [Vaccine == "MCV2",
                      vac_deaths_averted := vac_deaths_averted * adjustment_mcv]

  return (vaccine_impact_psa)

} # end of function -- measles_scenario
# ------------------------------------------------------------------------------


# ------------------------------------------------------------------------------
# main program
# ------------------------------------------------------------------------------

# start time
print (Sys.time ())

# move to base directory (run code from source directory)
source_wd <- getwd ()
setwd ("../")

set.seed (1)  # seed for random number generator
psa <- 4000   # number of runs for probabilistic sensitivity analysis

suspension_periods        <- c ( 6/12)  # unit in year
suspension_period_strings <- c ("6 months")

# potential delay or suspension period of EPI due to COVID-19
# suspension_periods        <- c ( 3/12,       6/12,       12/12)  # unit in year
# suspension_period_strings <- c ("3 months", "6 months", "12 months")

# low impact scenario -- only a measles outbreak with low chance
#                        and no other infectious disease outbreak
outbreak_chance      <- 0.25  # 25%
reduced_transmission <- 0.5   # 50% (social distancing will increase inter-pandemic period)

# scenarios: high impact and low impact
for (impact in c("low", "high")) {
  
  tic ()

  # different suspension periods
  for (period in 1:length (suspension_periods)) {

    # set suspension period
    suspension_period        <- suspension_periods        [period]
    suspension_period_string <- suspension_period_strings [period]

    # age group for vaccine impact -- "all" or "under5" age groups
    # age_groups <- c("under5", "all")
    age_groups <- c("under5")

    # age group for vaccine impact -- "all" or "under5" age groups
    for (age_group in age_groups) {

      # extract vaccine coverage estimates for 2018 from WHO for 54 African countries
      vaccine_coverage <- get_vaccine_coverage (age_group)

      # add population estimates from UNWPP 2019
      vaccine_coverage_pop <- add_population (vaccine_coverage)

      # add UN household size data from DHS / IPUMS
      vaccine_coverage_pop_hh <- add_hh_size_data (vaccine_coverage_pop)

      # add deaths averted by vaccination among "all" or "under5" age groups
      vaccine_impact_psa <- deaths_averted_vaccination (vaccine_coverage_pop_hh,
                                                        age_group = age_group,
                                                        suspension_period,
                                                        psa)

      # low impact scenario
      # adjust vaccine impact estimates for pessimistic measles scenario
      if (impact == "low") {

        vaccine_impact_psa <- measles_scenario (vaccine_impact_psa,
                                                suspension_period,
                                                outbreak_chance,
                                                reduced_transmission)
      }

      # estimate potential deaths due to covid-19 by continuing vaccination programmes
      vaccine_covid_impact <- estimate_covid_deaths (vaccine_impact_psa,
                                                     suspension_period,
                                                     psa)

      # --------------------------------------------------------------------------
      # estimate benefit risk ratio
      # country level
      benefit_risk <- benefit_risk_ratio (vaccine_covid_impact,
                                          suspension_period)

      # continental level
      benefit_risk_Africa <- benefit_risk_ratio_Africa (vaccine_covid_impact,
                                                        suspension_period)
      # --------------------------------------------------------------------------

      # --------------------------------------------------------------------------
      # estimate benefit risk ratio -- summary estimates (median, credible intervals)
      # country level
      benefit_risk_summary <- benefit_risk_ratio_summary (benefit_risk)

      # add country names
      benefit_risk_summary [, Country := countrycode (sourcevar   = ISO_code,
                                                      origin      = "iso3c",
                                                      destination = "country.name")]
      # set column order
      setcolorder (benefit_risk_summary, "Country")

      # continental level
      # rename Continent column to ISO_code
      setnames (benefit_risk_Africa, "Continent", "ISO_code")

      # estimate benefit risk ratio -- summary estimates (median, credible intervals)
      benefit_risk_summary_Africa <- benefit_risk_ratio_summary (benefit_risk_Africa)

      # rename ISO_code column back to Continent
      setnames (benefit_risk_summary_Africa, "ISO_code", "Continent")
      # --------------------------------------------------------------------------

      # generate map of benefit risk ratio
      benefit_risk_ratio_map (benefit_risk_summary,
                              suspension_period_string,
                              age_group = age_group,
                              impact)

      # save benefit-risk results
      save_benefit_risk_results (benefit_risk,
                                 benefit_risk_summary,
                                 benefit_risk_summary_Africa,
                                 suspension_period,
                                 suspension_period_string,
                                 age_group = age_group,
                                 impact)

      # produce tornado diagram
      fit <- tornado_regression (benefit_risk_Africa,
                                 vaccine_covid_impact,
                                 suspension_period_string,
                                 age_group = age_group,
                                 impact)

    } # end -- for (age_group in age_groups)

  } # end -- for (period in 1:length (suspension_periods))
  
  toc ()

} # end -- for (impact in c("high", "low"))

# return to source directory
setwd (source_wd)

# end time
print (Sys.time ())
# ------------------------------------------------------------------------------
